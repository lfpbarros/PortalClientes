{% load static %}
{% load i18n %}

{% block extra_head %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/onboarding.css' %}">
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block body_content %}
  <div class="sidebar">
    <h2 class="sidebar-logo-text">{% trans "Portal Clientes" %}</h2>
    <h3 class="sidebar-company-name">{% trans "Dashboard" %}</h3>

    {% if is_internal %}
      <a href="{% url 'customers:company_onboarding_create' %}" class="btn sidebar-back-button mt-4">
        <i class="fas fa-plus me-2"></i> {% trans "Novo Cliente" %}
      </a>
    {% endif %}
    <a href="{% url 'customers:dashboard' %}" class="btn sidebar-back-button mt-2">
      <i class="fas fa-chart-line me-2"></i> {% trans "Dashboard" %}
    </a>
    {% if is_internal %}
      <a href="{% url 'customers:company_list' %}" class="btn sidebar-back-button mt-2">
        <i class="fas fa-list me-2"></i> {% trans "Clientes" %}
      </a>
    {% endif %}
    <a href="{% url 'customers:rdd_list' %}" class="btn sidebar-back-button mt-2">
      <i class="fas fa-comments me-2"></i> {% trans "Conversas RDD" %}
    </a>

    <div class="mt-auto w-100">
      <a href="{% url 'logout' %}" class="btn sidebar-back-button mt-3">
        <i class="fas fa-sign-out-alt me-2"></i> {% trans "Sair" %}
      </a>
    </div>
  </div>

  <div class="main-content">
    <header class="header">
      <h1 class="header-title">{% trans "Dashboard" %}</h1>
      <img src="{% static 'images/logo.png' %}" alt="Logo PRIO" class="prio-logo">
    </header>

    <div class="form-area">
      <div class="d-flex justify-content-end mb-2">
        <button id="notifications-toggle-btn" type="button" class="btn btn-outline-secondary btn-sm">{% trans "Ocultar Notificações" %}</button>
      </div>
      {% if is_internal %}
        {% if unread_notifications %}
          <div class="notifications-block alert alert-info" role="alert">
            <strong>{% trans "Notificações" %}:</strong>
            <ul class="mb-0 mt-2">
              {% for n in unread_notifications %}
                <li>
                  {% if n.url %}<a href="{{ n.url }}">{{ n.message }}</a>{% else %}{{ n.message }}{% endif %}
                  <small class="text-muted"> · {{ n.created_at|date:"d/m/Y H:i" }}</small>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        {% if evaluation_due_companies %}
          <div class="alert alert-danger d-flex justify-content-between align-items-center" role="alert">
            <div>
              <strong>{% trans "Avaliações vencidas" %}:</strong>
              <span class="ms-2">{{ evaluation_due_companies|length }}</span>
              <ul class="mb-0 mt-2">
                {% for c in evaluation_due_companies|slice:":5" %}
                  <li>
                    <a href="{% url 'customers:company_detail' pk=c.pk %}">{{ c.full_company_name }}</a>
                    — {{ c.next_evaluation_date|date:"d/m/Y" }}
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}
        {% if evaluation_upcoming_companies %}
          <div class="alert alert-warning d-flex justify-content-between align-items-center" role="alert">
            <div>
              <strong>{% trans "Avaliações próximas (7 dias)" %}:</strong>
              <span class="ms-2">{{ evaluation_upcoming_companies|length }}</span>
              <ul class="mb-0 mt-2">
                {% for c in evaluation_upcoming_companies|slice:":5" %}
                  <li>
                    <a href="{% url 'customers:company_detail' pk=c.pk %}">{{ c.full_company_name }}</a>
                    — {{ c.next_evaluation_date|date:"d/m/Y" }}
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}
        {% if rdd_open_threads %}
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h6 class="text-muted mb-2">{% trans "Due Diligence Reversa" %}</h6>
              <ul class="mb-0">
                {% for t in rdd_open_threads %}
                  <li>
                    <a href="{% url 'customers:rdd_detail' pk=t.pk %}">{{ t.subject }}</a>
                    <span class="text-muted"> · {{ t.company.full_company_name }}</span>
                  </li>
                {% empty %}
                  <li class="text-muted">{% trans "Nenhuma solicitação aberta." %}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}
      {% endif %}
      {% if is_internal %}
        <div class="d-flex flex-wrap gap-2 mb-3">
          <a href="{% url 'customers:company_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-list me-1"></i> {% trans "Todos" %}
          </a>
          <a href="{% url 'customers:company_list' %}?status=pendente" class="btn btn-outline-warning btn-sm">
            <i class="fas fa-exclamation-circle me-1"></i> {% trans "Pendentes" %}
          </a>
          <a href="{% url 'customers:company_list' %}?status=concluido" class="btn btn-outline-success btn-sm">
            <i class="fas fa-check me-1"></i> {% trans "Concluídos" %}
          </a>
          <a href="{% url 'customers:company_list' %}?area=compliance&status=pendente" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-user-shield me-1"></i> {% trans "Compliance" %}
          </a>
          <a href="{% url 'customers:company_list' %}?area=financeiro&status=pendente" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-coins me-1"></i> {% trans "Financeiro" %}
          </a>
          <a href="{% url 'customers:company_list' %}?area=trading&status=pendente" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-chart-line me-1"></i> {% trans "Trading" %}
          </a>
          <a href="{% url 'customers:company_list' %}?area=suprimentos&status=pendente" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-file-invoice me-1"></i> {% trans "Suprimentos" %}
          </a>
        </div>
      {% endif %}
      {% if is_internal %}
        <div class="kpi-strip">
          <div class="kpi-pill bg-secondary text-white">
            <span class="kpi-label">{% trans "Empresas" %}</span>
            <span class="kpi-value">{{ total_companies }}</span>
          </div>
          <div class="kpi-pill bg-success text-white">
            <span class="kpi-label">{% trans "Concluídos" %}</span>
            <span class="kpi-value">{{ completed_count }}</span>
          </div>
          <div class="kpi-pill bg-warning text-dark">
            <span class="kpi-label">{% trans "Pendências" %}</span>
            <span class="kpi-value">{{ pending_flag_count }}</span>
          </div>
          <div class="kpi-pill bg-info text-dark">
            <span class="kpi-label">{% trans "Progresso Médio" %}</span>
            <span class="kpi-value">{{ avg_progress }}%</span>
          </div>
        </div>
      {% else %}
        <div class="alert alert-info d-flex justify-content-between align-items-center" role="alert">
          <div>
            <strong>{% trans "Bem-vindo(a)!" %}</strong>
            <span class="ms-2">{% trans "Estas são as suas pendências atuais." %}</span>
          </div>
          <span class="badge rounded-pill bg-primary px-3 py-2">
            {% trans "Pendências" %}: {{ pending_items|length }}
          </span>
        </div>
      {% endif %}

      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if is_internal %}
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card kpi-card shadow-sm">
              <div class="card-body">
                <h6 class="text-muted mb-1">{% trans "Total de Empresas" %}</h6>
                <div class="h3 mb-0">{{ total_companies }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card kpi-card shadow-sm">
              <div class="card-body">
                <h6 class="text-muted mb-1">{% trans "Onboarding Concluído" %}</h6>
                <div class="h3 mb-0">{{ completed_count }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card kpi-card shadow-sm">
              <div class="card-body">
                <h6 class="text-muted mb-1">{% trans "Pendências Marcadas" %}</h6>
                <div class="h3 mb-0">{{ pending_flag_count }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card kpi-card shadow-sm">
              <div class="card-body">
                <h6 class="text-muted mb-2">{% trans "Progresso Médio" %}</h6>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: {{ avg_progress }}%"></div>
                </div>
                <div class="small text-muted mt-1">{{ avg_progress }}%</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-md-4">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h6 class="text-muted mb-2">{% trans "Pendências por área" %}</h6>
                <ul class="list-group list-group-flush clean-list">
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {% trans "Compliance" %}<span class="badge bg-warning text-dark">{{ compliance_pending }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {% trans "Financeiro" %}<span class="badge bg-warning text-dark">{{ treasury_pending }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {% trans "Trading" %}<span class="badge bg-warning text-dark">{{ trading_pending }}</span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    {% trans "Suprimentos" %}<span class="badge bg-warning text-dark">{{ suprimentos_pending }}</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h6 class="text-muted mb-2">{% trans "Recentes" %}</h6>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>{% trans "Empresa" %}</th>
                        <th>{% trans "Criado em" %}</th>
                        <th>{% trans "Ações" %}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for c in recent_companies %}
                        <tr>
                          <td>{{ c.full_company_name }}</td>
                          <td>{{ c.created_at|date:"d/m/Y H:i" }}</td>
                          <td>
                            <a href="{% url 'customers:company_detail' pk=c.pk %}" class="btn btn-sm btn-outline-info">{% trans "Ver" %}</a>
                            <a href="{% url 'customers:company_onboarding_step' pk=c.pk step_slug='general_information' %}" class="btn btn-sm btn-outline-warning">{% trans "Onboarding" %}</a>
                          </td>
                        </tr>
                      {% empty %}
                        <tr><td colspan="3" class="text-muted">{% trans "Sem registros" %}</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

      {% else %}
        {% if min_pending_for_user %}
          <div class="alert alert-warning" role="alert">
            <strong>{% trans "Requisitos mínimos pendentes" %}:</strong>
            <ul class="mb-0 mt-2">
              {% for item in min_pending_for_user %}
                <li>
                  <a href="{% url 'customers:company_onboarding_step' pk=item.company.pk step_slug='general_information' %}">{{ item.company.full_company_name }}</a>
                  — {{ item.missing|join:", " }}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        <div class="d-flex justify-content-end mb-3">
          <a href="{% url 'customers:rdd_create' %}" class="btn btn-primary">
            <i class="fas fa-paper-plane me-2"></i> {% trans "Notificar Due Diligence Reversa" %}
          </a>
        </div>
        {% if unread_notifications %}
          <div class="notifications-block alert alert-info" role="alert">
            <strong>{% trans "Notificações" %}:</strong>
            <ul class="mb-0 mt-2">
              {% for n in unread_notifications %}
                <li>
                  {% if n.url %}<a href="{{ n.url }}">{{ n.message }}</a>{% else %}{{ n.message }}{% endif %}
                  <small class="text-muted"> · {{ n.created_at|date:"d/m/Y H:i" }}</small>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">{% trans "Suas Pendências" %}</h5>
            <div class="table-responsive">
              <table class="table table-striped align-middle">
                <thead>
                  <tr>
                    <th>{% trans "Empresa" %}</th>
                    <th>{% trans "Próxima Etapa" %}</th>
                    <th class="text-center">SLA</th>
                    <th class="text-center">{% trans "Ações" %}</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in pending_items %}
                    <tr>
                      <td>{{ item.company.full_company_name }}</td>
                      <td>{{ item.next_step_title }}</td>
                      <td class="text-center">
                        <span class="badge sla-badge" data-created="{{ item.company.created_at|date:'c' }}"></span>
                      </td>
                      <td class="text-center">
                        <a href="{% url 'customers:company_onboarding_step' pk=item.company.pk step_slug=item.next_step_slug %}"
                           class="btn btn-sm btn-primary">{% trans "Ir para etapa" %}</a>
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="3" class="text-muted">{% trans "Nenhuma pendência no momento." %}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="{% static 'js/table-filters.js' %}"></script>
  <script>
    (function(){
      const now = new Date();
      document.querySelectorAll('.sla-badge[data-created]')?.forEach(el => {
        const createdStr = el.getAttribute('data-created');
        const created = new Date(createdStr);
        if (isNaN(created.getTime())) return;
        const diffDays = Math.floor((now - created) / (1000*60*60*24));
        let text = 'Novo';
        let cls = 'bg-success';
        if (diffDays > 14) { text = 'Atrasado'; cls = 'bg-danger'; }
        else if (diffDays > 7) { text = 'Atenção'; cls = 'bg-warning text-dark'; }
        el.classList.add('rounded-pill', cls);
        el.style.padding = '0.35rem 0.6rem';
        el.textContent = text;
        el.title = `Criado há ${diffDays} dia(s)`;
      });
    })();
    (function(){
      const btn = document.getElementById('notifications-toggle-btn');
      const key = 'dashboardNotificationsHidden';
      function blocks() { return Array.from(document.querySelectorAll('.notifications-block')); }
      function update(hidden){
        blocks().forEach(el => el.classList.toggle('d-none', hidden));
        if (btn) btn.textContent = hidden ? 'Mostrar Notificações' : 'Ocultar Notificações';
        try { localStorage.setItem(key, hidden ? '1' : '0'); } catch(e) {}
      }
      let hidden = false;
      try { hidden = localStorage.getItem(key) === '1'; } catch(e) { hidden = false; }
      update(hidden);
      if (btn) btn.addEventListener('click', function(){
        const anyVisible = blocks().some(el => !el.classList.contains('d-none'));
        update(anyVisible);
      });
    })();
  </script>
{% endblock %}
